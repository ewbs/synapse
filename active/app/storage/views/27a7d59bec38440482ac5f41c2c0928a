<?php
/**
 * @var Eform $modelInstance
 */
$lastRevision=($modelInstance) ? $modelInstance->getLastRevisionEform() : null;
$nostraEditable=!($modelInstance && $modelInstance->nostra_form_id); // Les champs nostra ne peuvent être éditables que si l'eform n'est pas lié à un nostra_form
$aPiecesStates = DemarchePieceState::all ();
$disponible_en_ligne_items = Eform::disponibleEnLigne();
$deposable_en_ligne_items = Eform::deposableEnLigne();
$dematerialisation_items = Eform::dematerialisation();
$dematerialisation_canal_items = Eform::dematerialisationCanal();
$intervention_ewbs_items = Eform::interventionEwbs();


$language = Input::old('language', $lastRevision ? $lastRevision->language : '');
$priority = Input::old('priority', $lastRevision ? $lastRevision->priority : '');
$format = Input::old('format', $lastRevision ? $lastRevision->format : '');
$current_state = Input::old('current_state', $lastRevision ? $lastRevision->current_state_id : '');
$next_state = Input::old('next_state', $lastRevision ? $lastRevision->next_state_id : '');
?>


<?php $__env->startSection('title'); ?><?php echo ($modelInstance ? 'Edition' : 'Création'); ?> d'un formulaire <?php $__env->stopSection(); ?>
<?php $__env->startSection('content'); ?>
<div class="row">
	<div class="col-md-12">
		<div class="block-flat">
			<div class="header"><h3><?php echo ($modelInstance ? 'Edition' : 'Création'); ?> d'un formulaire</h3></div>
			<div class="content">
				<form class="form-horizontal" method="post" autocomplete="off" action="<?php echo ($modelInstance) ? $modelInstance->routePostEdit() : $model->routePostCreate(); ?>">
					<input type="hidden" name="_token" id="_token" value="<?php echo e(csrf_token()); ?>" />

					<div class="form-group">
						<label class="col-md-2 control-label" for="">Le formulaire est dématérialisé ?</label>
						<div class="col-md-10">
							<div class="switch">
								<input type="checkbox" name="is_dematerialise" <?php echo Input::old('is_dematerialise', $modelInstance ? ($modelInstance->is_dematerialise ? ' checked' : '') : ''); ?> />
							</div>

						</div>
					</div>
					
					<div class="form-group">
						<label class="col-md-2 control-label" for="name">Description</label>
						<div class="col-md-10">
							<textarea style="height: 100px;" class="form-control" name="description" id="description"><?php echo e(Input::old('description', $modelInstance ? $modelInstance->description : null)); ?></textarea><small class="pull-right"><?php echo Lang::get('general.optional'); ?></small></div>
					</div>
					<div class="form-group">
						<label class="col-md-2 control-label" for="name">Disponible en ligne</label>
						<div class="col-md-10">
							<select class="form-control select2" name="disponible_en_ligne" id="disponible_en_ligne" data-placeholder="Veuillez choisir une option">
								<?php foreach($disponible_en_ligne_items as $key => $value): ?>
									<option value="<?php echo $key; ?>"<?php echo Input::old('disponible_en_ligne', $modelInstance->disponible_en_ligne)==$key ?' selected':''; ?>><?php echo $value; ?></option>
								<?php endforeach; ?>
							</select>
						</div>
					</div>

					<div class="form-group">
						<label class="col-md-2 control-label" for="name">Déposable en ligne</label>
						<div class="col-md-10">
							<select class="form-control select2" name="deposable_en_ligne" id="deposable_en_ligne" data-placeholder="Veuillez choisir une option">
								<?php foreach($deposable_en_ligne_items as $key => $value): ?>
									<option value="<?php echo $key; ?>"<?php echo Input::old('deposable_en_ligne', $modelInstance->deposable_en_ligne)==$key ?' selected':''; ?>> <?php echo $value; ?></option>
								<?php endforeach; ?>
							</select>
						</div>
					</div>

					<div class="form-group <?php echo e($errors->has('dematerialisation') ? 'has-error' : ''); ?>">
						<label class="col-md-2 control-label" for="name">Dématérialisation</label>
						<div class="col-md-10">
							<select class="form-control select2 " name="dematerialisation" id="dematerialisation" data-placeholder="Veuillez choisir une option">
								<?php foreach($dematerialisation_items as $key => $value): ?>
									<option value="<?php echo $key; ?>"<?php echo Input::old('dematerialisation', $modelInstance->dematerialisation)==$key ?' selected':''; ?>> <?php echo $value; ?></option>
								<?php endforeach; ?>
							</select>
							<?php echo $errors->first('dematerialisation', '<span class="help-inline red">:message</span>'); ?>

							<div class="dematerialisation_date" style="margin-top: 10px; <?php echo Input::old('dematerialisation', $modelInstance->dematerialisation)=="oui" ? 'display: block' : 'display: none'; ?>">
								<input type="text" class="form-control" name="dematerialisation_date" id="dematerialisation_date" placeholder="mois/année"
									   value="<?php echo Input::old('dematerialisation_date', $modelInstance ? $modelInstance->dematerialisation_date : ''); ?>"
								/>
								<small class="pull-right">mois/année</small>
							</div>
							<div class="dematerialisation_canal" style="margin-top: 10px; <?php echo Input::old('dematerialisation', $modelInstance->dematerialisation)=="deja_effectue" ? 'display: block' : 'display: none'; ?>">
								Canal de dématérialisation : <br/>
								<select class="form-control select2" name="dematerialisation_canal" id="dematerialisation_canal" data-placeholder="Veuillez choisir une option">
									<?php foreach($dematerialisation_canal_items as $key => $value): ?>
										<option value="<?php echo $key; ?>"<?php echo Input::old('dematerialisation_canal', $modelInstance->dematerialisation_canal)==$key ?' selected':''; ?>> <?php echo $value; ?></option>
									<?php endforeach; ?>
								</select>
							</div>
							<div class="dematerialisation_canal_autres" style="margin-top: 10px; <?php echo Input::old('dematerialisation_canal', $modelInstance->dematerialisation_canal)=="autres" ? 'display: block' : 'display: none'; ?>">
								<input type="text" class="form-control" name="dematerialisation_canal_autres" id="dematerialisation_canal_autres" placeholder="Indiquer un canal de dématérialisation"
									   value="<?php echo Input::old('dematerialisation_canal_autres', $modelInstance ? $modelInstance->dematerialisation_canal_autres : ''); ?>"
								/>
							</div>
						</div>
					</div>

					<div class="form-group">
						<label class="col-md-2 control-label" for="name">Intervention eWBS</label>
						<div class="col-md-10">
							<select class="form-control select2" name="intervention_ewbs" id="intervention_ewbs" data-placeholder="Veuillez choisir une option">
								<?php foreach($intervention_ewbs_items as $key => $value): ?>
									<option value="<?php echo $key; ?>"<?php echo Input::old('intervention_ewbs', $modelInstance->intervention_ewbs)==$key ?' selected':''; ?>> <?php echo $value; ?></option>
								<?php endforeach; ?>
							</select>
							<div id="ajouteruneaction" style="<?php if(Input::old('intervention_ewbs', $modelInstance->intervention_ewbs) === 'oui'): ?> display: block; <?php else: ?> display: none; <?php endif; ?> text-align:right; padding-top: 15px;">
								<?php if($modelInstance->canManage()): ?>
									<button type="submit" class="btn btn-sm btn-primary servermodal" href="<?php echo route('eformsActionsGetCreate', [$modelInstance->id]); ?>" data-reload-datatable="table#datatable-eforms-actions"><i class="fa fa-plus"></i> Ajouter une action</button>
								<?php endif; ?>
							</div>
						</div>
					</div>

					<div class="form-group <?php echo e($errors->has('references_contrat_administration') ? 'has-error' : ''); ?>">
						<label class="col-md-2 control-label" for="name">Références Contrat d’administration</label>
						<div class="col-md-10">
							<input class="form-control" type="text" id="references_contrat_administration" name="references_contrat_administration"
								   value="<?php echo Input::old('references_contrat_administration', $modelInstance ? $modelInstance->references_contrat_administration : ''); ?>"
							/>
							<?php echo $errors->first('references_contrat_administration', '<span class="help-inline">:message</span>'); ?>

						</div>
					</div>

					<div class="form-group">
						<label class="col-md-2 control-label" for="name">Remarques</label>
						<div class="col-md-10">
							<textarea style="height: 100px;" class="form-control" name="remarques" id="remarques"><?php echo e(Input::old('remarques', $modelInstance ? $modelInstance->remarques : null)); ?></textarea><small class="pull-right"><?php echo Lang::get('general.optional'); ?></small></div>
					</div>
					
					<?php /* Champs Nostra, avec gestion du fait que si l'eform est lié à un nostra_form, les champs nostra ne sont plus éditables (et il faut alors inviter l'utilisateur à demander une modif => cf. workflow créant une action et envoyant un mail à l'équipe NOSTRA) */ ?>
					<fieldset>
						<legend>Données Nostra</legend>
						
						<div class="form-group <?php echo e($errors->has('title') ? 'has-error' : ''); ?>">
							<label class="col-md-2 control-label" for="title">Nom du formulaire</label>
							<div class="col-md-10">
								<input class="form-control" type="text" name="title" id="title" value="<?php echo Input::old('title', $lastRevision ? $lastRevision->title : ''); ?>"<?php echo ($nostraEditable ? '':' readonly'); ?>/>
								<?php echo $errors->first('title', '<span class="help-inline">:message</span>'); ?>

							</div>
						</div>
						
						<div class="form-group <?php echo e($errors->has('form_id') ? 'has-error' : ''); ?>">
							<label class="col-md-2 control-label" for="form_id">ID Slot</label>
							<div class="col-md-10">
								<input class="form-control" type="text" name="form_id" id="form_id" value="<?php echo Input::old('form_id', $lastRevision ? $lastRevision->form_id : ''); ?>"<?php echo ($nostraEditable ? '':' readonly'); ?>/><small class="pull-right"><?php echo Lang::get('general.optional'); ?></small><?php echo $errors->first('form_id', '<span class="help-inline">:message</span>'); ?>

							</div>
						</div>
						
						<div class="form-group">
							<label class="col-md-2 control-label" for="language">Langue</label>
							<div class="col-md-10">
								<select class="form-control" name="language" id="language"<?php echo ($nostraEditable ? '':' disabled'); ?>/>
									<option></option>
									<?php foreach(NostraForm::distinctColumn('language') as $item): ?>
									<option value="<?php echo $item->language; ?>"<?php echo $language==$item->language ?' selected':''; ?>><?php echo $item->language; ?></option>
									<?php endforeach; ?>
								</select><small class="pull-right"><?php echo Lang::get('general.optional'); ?></small></div>
						</div>
						
						<div class="form-group">
							<label class="col-md-2 control-label" for="priority">Priorité</label>
							<div class="col-md-10">
								<select class="form-control" name="priority" id="priority"<?php echo ($nostraEditable ? '':' disabled'); ?>/>
									<option></option>
									<?php foreach(NostraForm::distinctColumn('priority') as $item): ?>
									<option value="<?php echo $item->priority; ?>"<?php echo $priority==$item->priority ?' selected':''; ?>><?php echo $item->priority; ?></option>
									<?php endforeach; ?>
								</select><small class="pull-right"><?php echo Lang::get('general.optional'); ?></small></div>
						</div>
						
						<div class="form-group">
							<label class="col-md-2 control-label" for="format">Format</label>
							<div class="col-md-10">
								<select class="form-control" name="format" id="format"<?php echo ($nostraEditable ? '':' disabled'); ?>/>
									<option></option>
									<?php foreach(NostraForm::distinctColumn('format') as $item): ?>
									<option value="<?php echo $item->format; ?>"<?php echo $format==$item->format ?' selected':''; ?>><?php echo $item->format; ?></option>
									<?php endforeach; ?>
								</select><small class="pull-right"><?php echo Lang::get('general.optional'); ?></small></div>
						</div>
						
						<div class="form-group">
							<label class="col-md-2 control-label" for="url">Url</label>
							<div class="col-md-10">
								<input class="form-control" type="text" name="url" id="url" value="<?php echo Input::old('url', $lastRevision ? $lastRevision->url : ''); ?>"<?php echo ($nostraEditable ? '':' readonly'); ?>/><small class="pull-right"><?php echo Lang::get('general.optional'); ?></small></div>
						</div>
						
						<div class="form-group">
							<label class="col-md-2 control-label" for="smart">Formulaire intelligent</label>
							<div class="col-md-10">
								<div class="switch">
									<input type="checkbox" name="smart" value="1" <?php echo Input::old('smart', $lastRevision && $lastRevision->smart ? ' checked' : ''); ?><?php echo ($nostraEditable ? '':' disabled'); ?>/>
								</div>
							</div>
						</div>
						
						<div class="form-group">
							<label class="col-md-2 control-label" for="esign">Signable électroniquement</label>
							<div class="col-md-10">
								<div class="switch">
									<input type="checkbox" name="esign" value="1"<?php echo Input::old('esign', $lastRevision && $lastRevision->esign ? ' checked' : ''); ?><?php echo ($nostraEditable ? '':' disabled'); ?>/>
								</div>
							</div>
						</div>
						
						<div class="form-group">
							<label class="col-md-2 control-label" for="simplified">Simplifié</label>
							<div class="col-md-10">
								<div class="switch">
									<input type="checkbox" name="simplified" value="1"<?php echo Input::old('simplified', $lastRevision && $lastRevision->simplified ? ' checked' : ''); ?><?php echo ($nostraEditable ? '':' disabled'); ?>/>
								</div>
							</div>
						</div>
						<?php if(!$nostraEditable): ?>
						<div class="col-md-10 col-md-offset-2">
	<div class="alert alert-warning alert-white rounded">
		<div class="icon">
			<i class="fa fa-exclamation-triangle"></i>
		</div>
		<strong>Attention! </strong><?php echo ('<p>Ces données ne sont pas directement modifiables, car elles proviennent de Nostra.</p><button type="submit" id="nostraRequest" name="nostraRequest" value="true" class="btn btn-primary">Demander une modification à l\'équipe Nostra</button>'); ?>
	</div>
						</div>
						<?php endif; ?>
					</fieldset>
					
					<?php /* Champs sauvés au niveau de la révision */ ?>
					<fieldset>
						<legend>Révision</legend>
						
						<div class="form-group">
							<label class="col-md-2 control-label" for="current_state">Etat courant</label>
							<div class="col-md-10">
								<select class="form-control" name="current_state" id="current_state">
									<option></option>
									<?php foreach($aPiecesStates as $item): ?>
									<option value="<?php echo $item->id; ?>"<?php echo $current_state==$item->id ?' selected':''; ?>><?php echo $item->code; ?> : <?php echo $item->name; ?></option>
									<?php endforeach; ?>
								</select><small class="pull-right"><?php echo Lang::get('general.optional'); ?></small></div>
						</div>
						
						<div class="form-group">
							<label class="col-md-2 control-label" for="next_state">Etat suivant</label>
							<div class="col-md-10">
								<select class="form-control" name="next_state" id="next_state">
									<option></option>
									<?php foreach($aPiecesStates as $item): ?>
									<option value="<?php echo $item->id; ?>"<?php echo $next_state==$item->id ?' selected':''; ?>><?php echo $item->code; ?> : <?php echo $item->name; ?></option>
									<?php endforeach; ?>
								</select><small class="pull-right"><?php echo Lang::get('general.optional'); ?></small></div>
						</div>
						
						<div class="form-group">
							<label class="col-md-2 control-label" for="comment">Commentaire</label>
							<div class="col-md-10">
								<textarea style="height: 100px;" class="form-control" name="comment" id="comment"><?php echo e(Input::old('comment', null)); ?></textarea><small class="pull-right"><?php echo Lang::get('general.optional'); ?></small></div>
						</div>
					</fieldset>
					
					<div class="form-group">
						<div class="col-md-offset-2 col-md-10">
							<a class="btn btn-cancel" href="<?php echo $modelInstance ? $modelInstance->routeGetView() : $model->routeGetIndex(); ?>"><?php echo Lang::get('button.cancel'); ?></a>
							<button type="submit" class="btn btn-primary"><?php echo Lang::get('button.save'); ?></button>
						</div>
					</div>
				</form>
			</div>
		</div>
	</div>
</div>
<?php $__env->stopSection(); ?>

<?php $__env->startSection('scripts'); ?>
	<script lang="javascript">
        $(document).ready( function () {

            $("#deposable_en_ligne").change(function() {
                if(this.value === 'oui_formulaire_web_ou_application_en_ligne'){
                    $("#dematerialisation").val('deja_effectue').trigger('change');
                }
            });

            $("#dematerialisation").change(function() {
                if(this.value === 'oui'){
                    $(".dematerialisation_canal").hide();
                    $(".dematerialisation_date").show();
                }
                else if(this.value === 'deja_effectue'){
                    $(".dematerialisation_date").hide();
                    $(".dematerialisation_canal").show();
                }
                else {
                    $(".dematerialisation_date").hide();
                    $(".dematerialisation_canal").hide();
                }
            });

            $("#dematerialisation_canal").change(function() {
                if(this.value === 'autres'){
                    $(".dematerialisation_canal_autres").show();
                }
                else {
                    $(".dematerialisation_canal_autres").hide();
                }
            });

            $("#intervention_ewbs").change(function() {
                console.log(this.value);
               if(this.value === 'oui'){
                   $("#ajouteruneaction").show();
			   } else {
                   $("#ajouteruneaction").hide();
			   }
			});
        });
	</script>
<?php $__env->stopSection(); ?>
<?php echo $__env->make('site.layouts.container-fluid', array_except(get_defined_vars(), array('__data', '__path')))->render(); ?>