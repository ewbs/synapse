<?php $__env->startSection('title'); ?>Documentation de la démarche <em><?php echo $nostraDemarche->title; ?></em> <?php $__env->stopSection(); ?>
<?php $__env->startSection('content'); ?>
<form id="create-edit-demarche-form" method="post" action="<?php echo $modelInstance->routeGetEdit(); ?>" autocomplete="off" class="form-horizontal">
	<input type="hidden" id="_token" name="_token" value="<?php echo e(csrf_token()); ?>" /> <input type="hidden" name="nostra_demarche" value="<?php echo $nostraDemarche->id; ?>" />
	<div class="row">
		<div class="col-md-8">
			<div class="block-flat">
				<div class="header">
					<h4>Informations générales</h4>
				</div>
				<div class="content">

					<!-- administrations impliquées -->
					<?php $aSelectedAdministrations = Input::old('administrations', isset($aSelectedAdministrations) ? $aSelectedAdministrations : array()); ?>
					<div class="form-group">
						<label class="col-md-2 control-label" for="administrations">Administration(s)
							impliquée(s)</label>
						<div class="col-md-10">
							<select class="select2" multiple name="administrations[]" id="administrations">
								<?php
								// TODO : truc pas très propre que je fais dans la vue pour le moment, mais ce serait bien mieux à faire dans le controlleur.
								// on regarde si l'utilisateur connecté a des restrictions d'accès sur les administrations.
								// on n'affichera pas les administrions auquelles il n'a pas accès (on place les acceptées dans un tableau, simplement)
								// FIXME : Si jamais la démarche était déjà associée à une admin à laquelle on n'a pas droit, mais qu'elle est aussi associée à une admin à laquelle on a droit, on perd le lien correspondant à l'administration à laquelle on n'a pas droit lors de l'édition !
								$restrictedAdministrations = $loggedUser->getRestrictedAdministrationsIds ();
								?>
								<?php foreach($aRegions as $region): ?>
								<optgroup label="<?php echo $region->name; ?>">
									<?php foreach($region->administrations()->orderBy('name')->get() as $administration): ?>
										<?php if(count($restrictedAdministrations) > 0): ?>
											<?php if(in_array($administration->id, $restrictedAdministrations)): ?>
											<option value="<?php echo $administration->id; ?>" <?php echo in_array($administration->id, $aSelectedAdministrations) ? ' selected' : ''; ?>><?php echo $administration->name; ?></option>
											<?php endif; ?>
										<?php else: ?>
										<option value="<?php echo $administration->id; ?>" <?php echo in_array($administration->id, $aSelectedAdministrations) ? ' selected' : ''; ?>><?php echo $administration->name; ?></option>
										<?php endif; ?>
									<?php endforeach; ?>
								</optgroup>
								<?php endforeach; ?>
							</select><small class="pull-right"><?php echo Lang::get('general.optional'); ?></small></div>
					</div>
					<!-- ./ administrations impliquées -->

					<!-- volume -->
					<div class="form-group">
						<label class="col-md-2 control-label" for="">Volume</label>
						<div class="col-md-10">
							<select class="select2" name="volume">
								<option value=""></option>
								<?php foreach($aVolumes as $vol): ?>
									<option <?php echo e(Input::old('volume', isset($modelInstance) ? ($modelInstance->volume ? "selected" : "") : "")); ?> value="<?php echo $vol; ?>"><?php echo $vol; ?></option>
								<?php endforeach; ?>
							</select><small class="pull-right"><?php echo Lang::get('general.optional'); ?></small></div>
					</div>
					<!-- /volume -->

					<!-- Périmetre eWBS -->
					<div class="form-group">
						<label class="col-md-2 control-label" for="">Périmètre d'action eWBS ?</label>
						<div class="col-md-10">
							<div class="switch">
								<input type="checkbox" name="ewbs" <?php echo e(Input::old('ewbs', isset($modelInstance) ? ($modelInstance->ewbs ? "checked" : "") : "")); ?>/>
							</div>
						</div>
					</div>
					<!-- ./ Périmetre eWBS -->

					<!-- utilisation du formulaire electronique -->
					<?php if( ! count($nostraDemarche->nostraForms) ): ?>
					<input type="hidden" name="eform_usage" value="0" />
					<?php else: ?>
					<div class="form-group <?php echo e($errors->has('eform_usage') ? 'has-error' : ''); ?>">
						<label class="col-md-2 control-label" for="gain_real">Usage e-formulaire (%)</label>
						<div class="col-md-10">
							<input name="eform_usage" class="bslider form-control"
								type="text" data-slider-max="100" data-slider-min="0"
								data-slider-value="<?php echo e(Input::old('eform_usage', $modelInstance->eform_usage)); ?>"
								value="<?php echo e(Input::old('eform_usage', $modelInstance->eform_usage)); ?>" />
							<?php echo $errors->first('eform_usage', '<span class="help-inline">:message</span>'); ?>

						</div>
					</div>
					<?php endif; ?>
					<!-- ./ utilisation du formulaire electronique -->

					<!-- Personne de contact -->
					<div class="form-group">
						<label class="col-md-2 control-label" for="personne_de_contact">Personne de contact</label>
						<div class="col-md-10">
							<textarea style="height: 100px;" class="form-control" name="personne_de_contact" id="personne_de_contact" ><?php echo Input::old('personne_de_contact', isset($modelInstance) ? $modelInstance->personne_de_contact : ""); ?></textarea>
						</div>
					</div>
					<!-- ./ Personne de contact -->

					<!-- commentaire -->
					<div class="form-group <?php echo e($errors->has('comment') ? 'has-error' : ''); ?>">
						<label class="col-md-2 control-label" for="name">Commentaire</label>
						<div class="col-md-10">
							<textarea style="height: 100px;" class="form-control" name="comment" id="comment"><?php echo Input::old('comment', isset($modelInstance) ? $modelInstance->comment : ""); ?></textarea><small class="pull-right"><?php echo Lang::get('general.optional'); ?></small><?php echo $errors->first('comment', '<span class="help-inline">:message</span>'); ?>

						</div>
					</div>
					<!-- ./ commentaire -->

				</div>
			</div>

			<!-- Documentation -->
			<div class="block-flat">
				<div class="header">
					<h4>Documentation</h4>
				</div>
				<div class="content">
					<div class="form-group">
						<div class="col-sm-11 col-sm-offset-1" id="docLinksContainer">
							<?php if( ! count($modelInstance->docLinks) ): ?>
							<p>Aucune documentation n'a été liée à cette démarche. Ajoutez en dès maintenant.</p>
							<?php else: ?>
								<?php foreach($modelInstance->docLinks as $link): ?>
								<div class="onedocLink">
									<input type="hidden" name="docLinkId[]" value="<?php echo $link->id; ?>" />
									<div class="form-group">
										<label class="col-sm-2 control-label">Titre du lien</label>
										<div class="col-sm-10">
											<input name="docLinkTitle[]" class="form-control" type="text" placeholder="Nommez votre lien" value="<?php echo $link->name; ?>" />
										</div>
									</div>
									<div class="form-group">
										<label class="col-sm-2 control-label">URL du lien</label>
										<div class="col-sm-10">
											<input name="docLinkURL[]" class="form-control" type="text" placeholder="Indiquez le lien (http(s); file:// ou autre)" value="<?php echo $link->url; ?>" />
										</div>
									</div>
									<div class="form-group">
										<label class="col-sm-2 control-label">Description</label>
										<div class="col-sm-10">
											<textarea name="docLinkDescription[]" name="docLink[]" class="form-control" placeholder="Explication éventuelle"><?php echo $link->description; ?></textarea><small class="pull-right"><?php echo Lang::get('general.optional'); ?></small></div>
									</div>
									<a class="pull-right deleteDocLink"><span class="fa fa-remove"></span>
										supprimer ce lien</a>
									<div class="clearfix"></div>
									<hr />
								</div>
								<?php endforeach; ?>
							<?php endif; ?>
							<?php /* Les input sont volontairement en disabled sinon ils passent aussi dans le POST du formulaire et je ne le veux pas ne pas modifier cela. jQuery les enable quand nécessaire. */ ?>
							<div id="newLinkPattern" class="hidden">
								<div class="onedocLink">
									<input disabled="disabled" type="hidden" name="docLinkId[]" value="-1" />
									<div class="form-group">
										<label class="col-sm-2 control-label">Titre du lien</label>
										<div class="col-sm-10">
											<input disabled="disabled" name="docLinkTitle[]" class="form-control" type="text" placeholder="Nommez votre lien" value="" />
										</div>
									</div>
									<div class="form-group">
										<label class="col-sm-2 control-label">URL du lien</label>
										<div class="col-sm-10">
											<input disabled="disabled" name="docLinkURL[]"
												class="form-control" type="text"
												placeholder="Indiquez le lien (http(s); file:// ou autre)"
												value="" />
										</div>
									</div>
									<div class="form-group">
										<label class="col-sm-2 control-label">Commentaire</label>
										<div class="col-sm-10">
											<textarea disabled="disabled" name="docLinkDescription[]" class="form-control" placeholder="Explication éventuelle"></textarea>
										</div>
									</div>
									<a class="pull-right deleteDocLink"><span class="fa fa-remove"></span>supprimer ce lien</a>
									<div class="clearfix"></div>
									<hr />
								</div>
							</div>
							<a class="btn btn-default btn-sm" id="btn-add-docLink">Ajouter un lien de documentation</a>
						</div>
					</div>
				</div>
			</div>
			<!-- ./ Documentation externe -->

			<!-- Taxonomie -->
			<div class="block-flat">
				<div class="header">
					<h4>Taxonomie</h4>
				</div>
				<div class="content">
					<!-- tags -->
					<?php
					// recherche de l'élément à selectionner
					$selectedTags = [ ];
					if ($modelInstance)
						$selectedTags = $aSelectedTags; // passée par le controlleur (voir function getManage());
					if (Input::old ( 'tags' ))
						$selectedTags = Input::old ( 'tags' );
					?>
					<div class="form-group">
						<div class="col-md-12">
							<select class="form-control select2" name="tags[]" id="tags" multiple>
							<?php foreach($aTaxonomy as $category): ?>
								<optgroup label="<?php echo $category->name; ?>">
									<?php foreach($category->tags as $tag): ?>
									<option value="<?php echo $tag->id; ?>"<?php echo in_array($tag->id, $selectedTags) ? ' selected': ''; ?>><?php echo $tag->name; ?></option>
									<?php endforeach; ?>
								</optgroup>
							<?php endforeach; ?>
							</select><small class="pull-right"><?php echo Lang::get('general.optional'); ?></small></div>
					</div>
				</div>
			</div>
			<!-- ./Taxonomie -->

			<div class="block-flat">
				<div class="header">
					<h3>Gains</h3>
				</div>
				<div class="content">
	<div class="alert alert-warning alert-white rounded">
		<div class="icon">
			<i class="fa fa-exclamation-triangle"></i>
		</div>
		<strong>Attention! </strong><?php echo ('<br />Par défaut les gains sont automatiquement calculés sur base des sommes des gains des différentes pièces et tâches liées à la démarche.<br />Si vous souhaitez modifier manuellement ces montants, ils ne seront donc plus automatiquement calculés suite aux modifications effectuées au niveau des pièces et tâches de la démarche.<br /><a id="unlockGains" class="btn btn-default" href="#">Modifier manuellement ces montants</a><a id="lockGains" class="btn btn-default" style="display: none" href="#">Remettre les montants initiaux</a>'); ?>
	</div>
					<?php
					$gains = [
					'gain_potential_administration' => 'Gain potentiel administration',
					'gain_potential_citizen' => 'Gain potentiel usager',
					'gain_real_administration' => 'Gain effectif administration',
					'gain_real_citizen' => 'Gain effectif usager'
					];
					?>
					<?php foreach($gains as $name=>$label): ?>
					<div class="form-group <?php echo e($errors->has($name) ? 'has-error' : ''); ?>">
						<label for="<?php echo $name; ?>" class="col-md-4"><?php echo e($label); ?></label>
						<div class="col-md-8">
							<div class="input-group">
								<input name="<?php echo $name; ?>"
									data-old="<?php echo e(($lastRevision?$lastRevision->$name:'')); ?>"
									class="form-control decimalNumber lockedGain" type="text"
									value="<?php echo e(Input::old($name, (($lastRevision && $lastRevision->$name)?(NumberHelper::decimalFormat($lastRevision->$name)):''))); ?>"
									placeholder="calculé (<?php echo e(NumberHelper::decimalFormat($calculatedGains?$calculatedGains->$name:0)); ?>)"
									disabled /> <span class="input-group-addon">€</span>
							</div>
						</div>
						<?php echo $errors->first($name, '<span class="help-inline">:message</span>
						<script type="text/javascript">var mustUnlockGains=true;</script>
						'); ?>

					</div>
					<?php endforeach; ?>
					<!-- ./ Gains -->
				</div>
			</div>
		</div>
		<div class="col-md-4">
			<?php echo $__env->make('admin.demarches.blocs.projets_lies',['manage'=>true], array_except(get_defined_vars(), array('__data', '__path')))->render(); ?>
			<?php echo $__env->make('admin.demarches.blocs.infos_nostra',['manage'=>true], array_except(get_defined_vars(), array('__data', '__path')))->render(); ?>
		</div>
	</div>

	<div class="row">
		<div class="block-flat">
			<div class="content no-padding">
				<div class="form-group no-padding no-margin">
					<div class="col-md-12">
						<a class="btn btn-lg" href="<?php echo $modelInstance ? $modelInstance->routeGetView() : (isset($returnTo) && $returnTo ? route($returnTo) : $model->routeGetIndex()); ?>"><?php echo Lang::get('button.cancel'); ?></a>
						<button type="submit" class="btn btn-primary btn-lg"><?php echo Lang::get('button.save'); ?></button>
					</div>
				</div>
			</div>
		</div>
	</div>
</form>
<?php $__env->stopSection(); ?>

<?php $__env->startSection('scripts'); ?>
<script lang="javascript">
	$(document).ready(function () {
		$("#sidebar-collapse").trigger("click"); //fermer la sidebar
	});
</script>
<?php $__env->stopSection(); ?>

<?php echo $__env->make('site.layouts.container-fluid', array_except(get_defined_vars(), array('__data', '__path')))->render(); ?>